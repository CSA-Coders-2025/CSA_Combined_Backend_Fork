<!DOCTYPE html>
<html xmlns:layout="http://www.w3.org/1999/xhtml" xmlns:th="http://www.w3.org/1999/xhtml"
      layout:decorate="~{layouts/base}" lang="en">
<head>
    <title>Tinkle View</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.css" />
    <style>
        /* Custom style for highlighting long duration */
        .highlight-long {
            background-color: #f8d7da !important; 
            color: #842029 !important;
            font-weight: bold;
        }
        
        /* Chart container */
        .chart-container {
            height: 400px;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <!-- page title -->
    <th:block layout:fragment="title" th:remove="tag">Bathroom Statistics</th:block>
    <th:block layout:fragment="body" th:remove="tag">
        <div class="container py-4 bg-primary rounded">
            <!-- Main page content -->
            <header class="pb-3 mb-4 border-bottom">
                <a href="#" class="d-flex align-items-center text-light text-decoration-none">
                    <span class="fs-4">Tinkle View</span>
                </a>
            </header>

            <div class="container py-4 text-light bg-success rounded">
                <h2>User Entries</h2>

                <div class="row align-items-md-stretch">
                    <div class="table-responsive">
                        <table id="userEntriesTable" class="table">
                            <thead>
                                <tr>
                                    <th class="sortable-header">Person Name</th>
                                    <th class="sortable-header">Day</th>
                                    <th class="sortable-header">Time In</th>
                                    <th class="sortable-header">Duration (HH:MM:SS)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="entry : ${tinkleList}">
                                    <td th:text="${entry.person_name}"></td>
                                    <td class="day-column" th:text="${entry.day}"></td>
                                    <td class="time-in-cell" th:utext="${entry.timeIn}"></td>
                                    <td th:text="${entry.duration}"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="container py-4 bg-primary rounded mt-4">
            <header class="pb-3 mb-4 border-bottom">
                <a href="#" class="d-flex align-items-center text-light text-decoration-none">
                    <span class="fs-4">Average Weekly Duration</span>
                </a>
            </header>

            <div class="container py-4 text-light bg-success rounded">
                <h2>Average Weekly Duration per User</h2>

                <div class="row align-items-md-stretch">
                    <div class="table-responsive">
                        <table id="weeklyDurationTable" class="table">
                            <thead>
                                <tr>
                                    <th class="sortable-header">Person Name</th>
                                    <th class="sortable-header">Average weekly duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="entry : ${averageWeeklyDurations}">
                                    <td th:text="${entry.key}"></td>
                                    <td th:text="${entry.value}"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="container py-4 bg-primary rounded mt-4">
            <header class="pb-3 mb-4 border-bottom">
                <a href="#" class="d-flex align-items-center text-light text-decoration-none">
                    <span class="fs-4">Data Visualization</span>
                </a>
            </header>

            <div class="container py-4 text-light bg-success rounded">
                <h2>Average Weekly Duration Visualization</h2>

                <div class="row align-items-md-stretch">
                    <div class="chart-container">
                        <canvas id="weeklyDurationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>

        <script th:inline="javascript">
            $(document).ready(function () {
                // Prepare bar chart data
                const labels = /*[[${chartLabels}]]*/ [];
                const data = /*[[${chartData}]]*/ [];
                const formattedData = data.map(seconds => (seconds / 60).toFixed(2));

                const ctx = $('#weeklyDurationChart')[0].getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Average Weekly Duration (Minutes)',
                            data: formattedData,
                            backgroundColor: 'rgba(40, 167, 69, 0.2)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Duration (Minutes)' }
                            },
                            x: { title: { display: true, text: 'Users' } }
                        }
                    }
                });

                // Initialize DataTables with pagination, sorting, and searching
                $('#userEntriesTable').DataTable({
                    paging: true,
                    searching: true,
                    ordering: true,
                    lengthMenu: [5, 10, 25, 50],
                    pageLength: 5,
                    responsive: true,
                    autoWidth: false,
                    language: {
                        search: "üîç Search:",
                        lengthMenu: "Show _MENU_ entries per page",
                        zeroRecords: "No matching records found",
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                        infoFiltered: "(filtered from _MAX_ total entries)",
                        paginate: {
                            first: '<i class="bi bi-chevron-double-left"></i>',
                            last: '<i class="bi bi-chevron-double-right"></i>',
                            next: '<i class="bi bi-chevron-right"></i>',
                            previous: '<i class="bi bi-chevron-left"></i>'
                        }
                    },
                    columnDefs: [
                        { targets: 1, type: 'date' }, // Day column
                        { targets: 2, type: 'string' }, // Time In column
                        { targets: 3, type: 'num' }   // Duration column
                    ]
                });

                // Initialize DataTables for the average duration table
                $('#weeklyDurationTable').DataTable({
                    paging: true,
                    searching: true,
                    ordering: true,
                    lengthMenu: [5, 10, 25, 50],
                    pageLength: 5,
                    responsive: true,
                    autoWidth: false,
                    language: {
                        search: "üîç Search:",
                        lengthMenu: "Show _MENU_ entries per page",
                        zeroRecords: "No matching records found",
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                        infoFiltered: "(filtered from _MAX_ total entries)",
                        paginate: {
                            first: '<i class="bi bi-chevron-double-left"></i>',
                            last: '<i class="bi bi-chevron-double-right"></i>',
                            next: '<i class="bi bi-chevron-right"></i>',
                            previous: '<i class="bi bi-chevron-left"></i>'
                        }
                    },
                });

                // Highlight excessive duration pairs
                const thresholdMinutes = 15;
                $('.time-in-cell').each(function () {
                    const cellText = $(this).text().trim();
                    if (!cellText) return;

                    const pairs = cellText.split(',');
                    const newHTML = pairs.map(pair => {
                        let trimmed = pair.trim();
                        let times = trimmed.split("--");

                        if (times.length === 2) {
                            // Convert HH:MM to minutes for comparison
                            const startParts = times[0].split(':');
                            const endParts = times[1].split(':');
                            
                            const startMinutes = parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
                            const endMinutes = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);
                            
                            const diffMinutes = endMinutes - startMinutes;
                            
                            if (diffMinutes > thresholdMinutes) {
                                return `<span class="highlight-long">${trimmed}</span>`;
                            }
                        }
                        return trimmed;
                    }).join(", ");

                    $(this).html(newHTML);
                });
            });
        </script>
    </th:block>
</body>
</html>