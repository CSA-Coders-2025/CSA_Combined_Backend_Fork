<!DOCTYPE HTML>
<html xmlns:layout="http://www.w3.org/1999/xhtml" xmlns:th="http://www.w3.org/1999/xhtml" layout:decorate="~{layouts/base}" lang="en">

<div class="container py-4">
    <header class="pb-3 mb-4 border-bottom border-primary text-light">
        <span class="fs-4">Create Account</span>
    </header>
</div>

<th:block layout:fragment="body" th:remove="tag">

    <div class="container py-4">
        <header class="pb-3 mb-4 border-bottom border-primary text-light">
            <span class="fs-4">Create Account</span>
        </header>
    </div>

<head>
    <title>Create Account</title>
    <script>
        var validatedGithub = false;
        var lastApiCallTime = 0;  // To throttle API requests
        var typingTimer;          // Timer for debouncing user input
        const debounceDelay = 500; // 5 seconds debounce delay
        const throttleInterval = 500; // 5 seconds throttle interval

        // Function to validate the form before submission
        function validateForm(event) {
            if(!validatedGithub) {
                alert("You must validate your Github Username!");
                event.preventDefault();
                return;
            }

            const password = document.getElementById("password").value;
            const confirmPassword = document.getElementById("confirm_password").value;
            
            if (password !== confirmPassword) {
                alert("Passwords do not match!");
                event.preventDefault();
                return;
            }
        }

        // Function to check if the GitHub username exists using GitHub's API
        function checkGitHubUsername() {
            const githubUsername = document.getElementById("ghid").value;
            const url = `https://api.github.com/users/${githubUsername}`;

            const currentTime = Date.now();
            // Throttle the API requests (once every 5 seconds)
            if (currentTime - lastApiCallTime < throttleInterval) {
                return; // Skip this call if it's within the throttle interval
            }
            
            // Update last API call time
            lastApiCallTime = currentTime;

            // Fetch data from GitHub API to validate the username
            fetch(url)
                .then(response => {
                    if (response.ok) {
                        return response.json(); // Parse response as JSON
                    } else {
                        throw new Error('Invalid GitHub username.');
                    }
                })
                .then(data => {
                    // Mark the GitHub username as validated
                    validatedGithub = true; // Mark the GitHub username as validated
                })
                .catch(error => {
                    alert(error.message); // Display error if the GitHub username is invalid
                });
        }

        // Debounced function to handle input from user
        function handleTyping() {
            clearTimeout(typingTimer); // Clear the previous timer
            typingTimer = setTimeout(checkGitHubUsername, debounceDelay); // Set a new timer for 5 seconds
        }
    </script>
</head>

<body>
    <div class="container py-4 text-light bg-primary rounded">
        <div class="container bg-secondary py-4 rounded">
            <div class="p-5 mb-4 bg-success text-light rounded-3">

                <div class="container">
                    <div class="row justify-content-md-center">
                        <div class="col8">
                            <div class="jumbotron">
                                <h3>Create New Account</h3>
                                <form class="form-inline" action="#" th:action="@{/mvc/person/create}" th:object="${person}" method="POST" onsubmit="validateForm(event)">
                                    <div class="input-group mb-2 mr-sm-2">
                                        <input type="text" th:field="*{ghid}" id="ghid" placeholder="Enter GitHub ID" oninput="handleTyping()">
                                        <small th:if="${#fields.hasErrors('ghid')}" th:errors="*{ghid}">GitHub ID Error</small>
                                    </div>

                                    <div class="input-group mb-2 mr-sm-2">
                                        <input type="text" th:field="*{name}" id="name" placeholder="Display Name">
                                        <small th:if="${#fields.hasErrors('name')}" th:errors="*{name}">Username Error</small>
                                    </div>

                                    <div class="form-group mb-2 mr-sm-2">
                                        <input type="password" th:field="*{password}" id="password" placeholder="Password">
                                        <small th:if="${#fields.hasErrors('password')}" th:errors="*{password}">Password Error</small>
                                    </div>

                                    <div class="form-group mb-2 mr-sm-2">
                                        <input type="password" id="confirm_password" placeholder="Confirm Password">
                                    </div>

                                    <div class="input-group mb-2 mr-sm-2">
                                        <label for="kasmServerNeeded"> Request Kasm Server: </label>
                                        <input type="checkbox" th:field="*{kasmServerNeeded}" id="kasmServerNeeded">
                                        <small th:if="${#fields.hasErrors('kasmServerNeeded')}" th:errors="*{kasmServerNeeded}">Kasm Server Needed Error</small>
                                    </div>

                                    <!-- Create Account Button -->
                                    <button type="submit" class="btn btn-secondary ">Create Account</button>

                                    <!-- Log In Button aligned to the right -->
                                    <a th:href="@{/login}">Log In</a>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
